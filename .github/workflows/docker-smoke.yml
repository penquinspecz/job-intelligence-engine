name: Docker Smoke

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  smoke:
    runs-on: ubuntu-latest
    env:
      CONTAINER_NAME: jobintel_smoke
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Guard against tracked CI artifacts
        run: |
          tracked="$(git ls-files ci_data ci_state ci_artifacts)"
          if [ -n "$tracked" ]; then
            echo "Tracked CI artifacts detected (ci_data/ ci_state/ ci_artifacts/)."
            echo "These directories must not be committed. Remove them from git and add to .gitignore."
            echo "$tracked"
            exit 1
          fi

      - name: Docker Diagnostics
        run: |
          echo "Image tag: ${JOBINTEL_IMAGE_TAG:-jobintel:local}"
          docker context show || true
          docker version || true
          docker info || true
          docker image ls | head || true

      - name: Build image
        run: |
          make image-ci

      - name: Smoke Config
        run: |
          make print-config
          docker version || true
          docker info || true

      - name: Prepare smoke artifacts dir
        run: |
          mkdir -p smoke_artifacts

      - name: Run smoke (containerized)
        id: smoke
        continue-on-error: true
        env:
          SMOKE_SKIP_BUILD: "1"
          SMOKE_ARTIFACTS_DIR: ${{ github.workspace }}/smoke_artifacts
        run: |
          ./scripts/smoke_docker.sh --skip-build --providers openai --profiles cs

      - name: Tail logs on failure
        if: steps.smoke.outcome != 'success'
        run: |
          if [ -f smoke_artifacts/exit_code.txt ]; then
            echo "Smoke exit code: $(cat smoke_artifacts/exit_code.txt)"
          fi
          if [ -f smoke_artifacts/smoke.log ]; then
            echo "---- tail smoke_artifacts/smoke.log (last 200 lines) ----"
            tail -n 200 smoke_artifacts/smoke.log || true
          fi
        continue-on-error: true

      - name: Smoke summary
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          artifacts = Path("smoke_artifacts")
          summary_path = os.environ.get("GITHUB_STEP_SUMMARY")
          if not summary_path:
            raise SystemExit(0)

          def _read_text(path: Path):
            try:
              return path.read_text(encoding="utf-8").strip()
            except Exception:
              return None

          def _load_json(path: Path):
            try:
              return json.loads(path.read_text(encoding="utf-8"))
            except Exception:
              return None

          exit_code = _read_text(artifacts / "exit_code.txt") or "unknown"
          metadata = _load_json(artifacts / "metadata.json") or {}
          providers = metadata.get("providers") or ["openai"]
          profiles = metadata.get("profiles") or ["cs"]

          report = _load_json(artifacts / "run_report.json") or {}
          selection = report.get("selection") or {}
          classified = selection.get("classified_job_count")
          classified_by_provider = selection.get("classified_job_count_by_provider") or {}

          ranked_counts = []
          for provider in providers:
            labeled_path = artifacts / f"{provider}_labeled_jobs.json"
            labeled = _load_json(labeled_path)
            labeled_count = len(labeled) if isinstance(labeled, list) else None
            for profile in profiles:
              ranked_path = artifacts / f"{provider}_ranked_jobs.{profile}.json"
              ranked = _load_json(ranked_path)
              ranked_count = len(ranked) if isinstance(ranked, list) else None
              ranked_counts.append((provider, profile, ranked_count, labeled_count))

          required_missing = []
          for provider in providers:
            required = [f"{provider}_labeled_jobs.json"]
            for profile in profiles:
              required.append(f"{provider}_ranked_jobs.{profile}.json")
              required.append(f"{provider}_ranked_jobs.{profile}.csv")
            for name in required:
              if not (artifacts / name).exists():
                required_missing.append(name)
          if not (artifacts / "run_report.json").exists():
            required_missing.append("run_report.json")

          lines = []
          lines.append("### Smoke summary")
          lines.append(f"- Exit code: `{exit_code}`")
          lines.append(f"- Providers: `{', '.join(providers)}`")
          lines.append(f"- Profiles: `{', '.join(profiles)}`")
          if classified is not None:
            lines.append(f"- classified_job_count: `{classified}`")
          if classified_by_provider:
            lines.append(f"- classified_job_count_by_provider: `{classified_by_provider}`")
          for provider, profile, ranked_count, labeled_count in ranked_counts:
            parts = [f"{provider}/{profile}"]
            if ranked_count is not None:
              parts.append(f"ranked={ranked_count}")
            if labeled_count is not None:
              parts.append(f"labeled={labeled_count}")
            lines.append(f"- counts: `{', '.join(parts)}`")
          delta_summary = report.get("delta_summary")
          if delta_summary is not None:
            lines.append(f"- delta_summary: `{json.dumps(delta_summary)[:500]}`")
          if required_missing:
            lines.append(f"- missing artifacts: `{', '.join(required_missing)}`")
          else:
            lines.append("- missing artifacts: `none`")

          with open(summary_path, "a", encoding="utf-8") as handle:
            handle.write("\n".join(lines) + "\n")
          PY

      - name: Upload smoke artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jobintel-smoke-artifacts
          path: smoke_artifacts/**
          retention-days: 7

      - name: "Gate: fail if smoke failed"
        if: always()
        run: |
          if [ ! -d smoke_artifacts ]; then
            mkdir -p smoke_artifacts
            python -c "import json; from pathlib import Path; artifacts=Path('smoke_artifacts'); artifacts.mkdir(parents=True, exist_ok=True); (artifacts/'run_report.json').write_text(json.dumps({'run_id':'unknown','status':'failed','success':False,'error':'smoke_artifacts_missing'}, sort_keys=True), encoding='utf-8'); (artifacts/'smoke_summary.json').write_text(json.dumps({'status':'failed','exit_code':1,'missing_artifacts':['smoke_artifacts_dir']}, sort_keys=True), encoding='utf-8')"
            echo "Smoke artifacts directory was missing; failing gate."
            exit 1
          fi
          code=1
          if [ -f smoke_artifacts/exit_code.txt ]; then
            code="$(cat smoke_artifacts/exit_code.txt)"
          fi
          missing=0
          for file in openai_labeled_jobs.json openai_ranked_jobs.cs.json openai_ranked_jobs.cs.csv run_report.json; do
            if [ ! -f "smoke_artifacts/$file" ]; then
              echo "Missing artifact: smoke_artifacts/$file"
              missing=1
            fi
          done
          if [ "$code" -ne 0 ] || [ "$missing" -ne 0 ]; then
            echo "Smoke failed (exit_code=$code, missing_outputs=$missing)"
            ls -la smoke_artifacts || true
            exit 1
          fi

name: ci

on:
  push:
    branches: [main]
  pull_request:

jobs:
  doctor:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.14.3"
      - name: Python/platform fingerprint
        run: |
          python --version
          python - <<'PY'
          import platform
          import sys
          print(f"python_executable={sys.executable}")
          print(f"python_version={sys.version}")
          print(f"platform={platform.platform()}")
          PY
      - name: Prepare .venv for doctor
        run: |
          python -m venv .venv
      - name: Doctor guardrails
        run: make doctor

  gate:
    runs-on: ubuntu-latest
    needs: doctor
    env:
      DOCKER_BUILDKIT: "1"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.14.3"
          cache: "pip"
          cache-dependency-path: "requirements.txt"
      - name: Python/platform fingerprint
        run: |
          python --version
          python - <<'PY'
          import platform
          import sys
          print(f"python_executable={sys.executable}")
          print(f"python_version={sys.version}")
          print(f"platform={platform.platform()}")
          PY
      - name: Install deps
        run: |
          python -m venv .venv
          .venv/bin/python -m pip install --upgrade pip==25.0.1 setuptools wheel pip-tools==7.4.1
          .venv/bin/python -m pip install -r requirements.txt
          .venv/bin/python -m pip install -e .
          .venv/bin/python -m pip install -e ".[dev]"
      - name: Gate (pytest offline harness defaults)
        run: |
          # AWS-safe test defaults live in tests/conftest.py.
          # Keep CI aligned with local pytest behavior; avoid inline AWS_* exports.
          make gate-ci
      - name: Determinism contract checks
        run: |
          set -euo pipefail
          export JOBINTEL_DATA_DIR=/tmp/jobintel_ci_data
          export JOBINTEL_STATE_DIR=/tmp/jobintel_ci_state
          .venv/bin/python - <<'PY'
          from pathlib import Path
          import json
          from ji_engine.utils.verification import compute_sha256_file
          data_dir = Path("/tmp/jobintel_ci_data")
          state_dir = Path("/tmp/jobintel_ci_state")
          data_dir.mkdir(parents=True, exist_ok=True)
          run_dir = state_dir / "runs" / "ci-run"
          run_dir.mkdir(parents=True, exist_ok=True)
          ranked = data_dir / "openai_ranked_jobs.cs.json"
          ranked.write_text("[]", encoding="utf-8")
          report = {
              "run_id": "ci-run",
              "run_report_schema_version": 1,
              "verifiable_artifacts": {
                  "openai:cs:ranked_json": {
                      "path": ranked.name,
                      "sha256": compute_sha256_file(ranked),
                      "bytes": ranked.stat().st_size,
                      "hash_algo": "sha256",
                  }
              },
          }
          (run_dir / "run_report.json").write_text(json.dumps(report), encoding="utf-8")
          PY
          .venv/bin/python scripts/publish_s3.py --run-dir /tmp/jobintel_ci_state/runs/ci-run --plan --json
          .venv/bin/python scripts/replay_run.py --run-dir /tmp/jobintel_ci_state/runs/ci-run --profile cs --strict --json
      - name: CronJob smoke (offline)
        run: make cronjob-smoke
      - name: Roadmap discipline guard (warn-only)
        continue-on-error: true
        run: .venv/bin/python scripts/check_roadmap_discipline.py
